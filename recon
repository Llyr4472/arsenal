#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# recon - small recon helper script
# Updates:
# - commented out amass enumeration command
# - made merge step robust when amass output or other sources are absent

OUT_DIR="output"
TARGETS_FILE="targets.txt"
MERGED_FILE="$OUT_DIR/all-subdomains.txt"

mkdir -p "$OUT_DIR"

# Example of how to run various enumeration tools. Uncomment and adjust as needed.
# AMASS (commented out by default because it can be noisy and is optional)
# echo "Running amass..."
# amass enum -d example.com -o "$OUT_DIR/amass.txt" || echo "amass failed or skipped"

# Sublist3r (example)
# echo "Running sublist3r..."
# sublist3r -d example.com -o "$OUT_DIR/sublist3r.txt" || echo "sublist3r failed or skipped"

# Example: using assetfinder
# echo "Running assetfinder..."
# assetfinder --subs-only example.com | tee "$OUT_DIR/assetfinder.txt" || echo "assetfinder failed or skipped"

# You can add your preferred enumeration commands above. The merge step below
# will only include files that actually exist and contain data.

# MERGE STEP: Collect all discovered subdomain files into one unique list.
# We look for files with common names/extensions in the output directory.

temp_file=$(mktemp)
trap 'rm -f "$temp_file"' EXIT

# Patterns to include in the merge. Add/remove as appropriate.
patterns=("*amass*.txt" "*sublist3r*.txt" "*assetfinder*.txt" "*crtsh*.txt" "*subdomains*.txt" "*.txt")

found_any=0
for pat in "${patterns[@]}"; do
  # Use globbing to expand pattern; nullglob-like behavior emulated
  shopt -s nullglob 2>/dev/null || true
  for f in "$OUT_DIR"/$pat; do
    if [[ -f "$f" && -s "$f" ]]; then
      echo "Including: $f" >&2
      found_any=1
      # Normalize CRLF, strip extra spaces, and append
      sed 's/\r//g' "$f" | tr -d '\r' >> "$temp_file" || true
    fi
  done
  shopt -u nullglob 2>/dev/null || true
done

if [[ $found_any -eq 0 ]]; then
  echo "No enumeration output files found in $OUT_DIR. $MERGED_FILE will be empty." >&2
  # Ensure merged file exists but is empty
  : > "$MERGED_FILE"
  exit 0
fi

# Normalize, filter empty lines, dedupe and sort
awk '{$1=$1; if (length($0)>0) print}' "$temp_file" | sort -u > "$MERGED_FILE"

echo "Merged subdomains saved to: $MERGED_FILE" >&2

exit 0
